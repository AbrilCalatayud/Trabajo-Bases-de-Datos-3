<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Empleados - {{ sucursal }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Sistema de Gestión de Empleados</h1>
            <h2>{{ sucursal }} (Puerto: {{ puerto }})</h2>
            <div class="status">
                <span id="status-sync" class="sync-status">Sincronizando...</span>
            </div>
        </header>

        <div class="sections">
            <section class="form-section">
                <h3>Agregar Empleado</h3>
                <form id="form-agregar">
                    <input type="text" name="dni" placeholder="DNI" required>
                    <input type="text" name="nombre" placeholder="Nombre" required>
                    <input type="text" name="apellido" placeholder="Apellido" required>
                    <input type="text" name="puesto" placeholder="Puesto" required>
                    <button type="submit">Agregar Empleado</button>
                </form>
                <div id="resultado-agregar" class="resultado"></div>
            </section>

            <section class="form-section">
                <h3>Editar Empleado</h3>
                <form id="form-editar">
                    <input type="text" name="dni" placeholder="DNI" required>
                    <input type="text" name="nombre" placeholder="Nuevo Nombre" required>
                    <input type="text" name="apellido" placeholder="Nuevo Apellido" required>
                    <input type="text" name="puesto" placeholder="Nuevo Puesto" required>
                    <button type="submit">Editar Empleado</button>
                </form>
                <div id="resultado-editar" class="resultado"></div>
            </section>

            <section class="form-section">
                <h3>Consultar Empleado</h3>
                <form id="form-consultar">
                    <input type="text" name="dni" placeholder="DNI" required>
                    <button type="submit">Consultar Empleado</button>
                </form>
                <div id="resultado-consulta" class="resultado"></div>
            </section>
        </div>

        <div class="actions">
            <button id="btn-ver-historial">Ver Historial Completo</button>
            <button id="btn-ver-empleados">Ver Todos los Empleados</button>
        </div>

        <section id="seccion-historial" class="hidden">
            <h3>Historial de Operaciones</h3>
            <div id="historial" class="historial"></div>
        </section>

        <section id="seccion-empleados" class="hidden">
            <h3>Todos los Empleados</h3>
            <div id="lista-empleados" class="empleados"></div>
        </section>
    </div>

    <script>
        // Actualizar estado de sincronización
        function actualizarEstadoSincronizacion(mensaje) {
            const statusElement = document.getElementById('status-sync');
            statusElement.textContent = mensaje;
            statusElement.classList.add('syncing');
            
            setTimeout(() => {
                statusElement.textContent = 'Sincronizado';
                statusElement.classList.remove('syncing');
            }, 2000);
        }

        // Funciones para manejar los formularios
        document.getElementById('form-agregar').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const resultado = document.getElementById('resultado-agregar');
            
            fetch('/agregar_empleado', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.exito) {
                    resultado.innerHTML = `<p class="success">${data.mensaje}</p>`;
                    this.reset();
                    actualizarEstadoSincronizacion('Sincronizando después de agregar...');
                } else {
                    resultado.innerHTML = `<p class="error">${data.mensaje}</p>`;
                }
            })
            .catch(error => {
                resultado.innerHTML = `<p class="error">Error: ${error}</p>`;
            });
        });

        document.getElementById('form-editar').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const resultado = document.getElementById('resultado-editar');
            
            fetch('/editar_empleado', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.exito) {
                    resultado.innerHTML = `<p class="success">${data.mensaje}</p>`;
                    this.reset();
                    actualizarEstadoSincronizacion('Sincronizando después de editar...');
                } else {
                    resultado.innerHTML = `<p class="error">${data.mensaje}</p>`;
                }
            })
            .catch(error => {
                resultado.innerHTML = `<p class="error">Error: ${error}</p>`;
            });
        });

        document.getElementById('form-consultar').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const resultado = document.getElementById('resultado-consulta');
            
            fetch('/consultar_empleado', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.exito) {
                    resultado.innerHTML = `
                        <h4>Empleado Encontrado:</h4>
                        <p><strong>DNI:</strong> ${data.empleado.dni}</p>
                        <p><strong>Nombre:</strong> ${data.empleado.nombre} ${data.empleado.apellido}</p>
                        <p><strong>Puesto:</strong> ${data.empleado.puesto}</p>
                        <p><strong>Sucursal:</strong> ${data.empleado.sucursal}</p>
                    `;
                    actualizarEstadoSincronizacion('Sincronizando después de consultar...');
                } else {
                    resultado.innerHTML = `<p class="error">${data.mensaje}</p>`;
                }
            })
            .catch(error => {
                resultado.innerHTML = `<p class="error">Error: ${error}</p>`;
            });
        });

        // Botón para ver historial
        document.getElementById('btn-ver-historial').addEventListener('click', function() {
            fetch('/ver_historial')
            .then(response => response.json())
            .then(data => {
                // Mostrar historial
                const historialDiv = document.getElementById('historial');
                historialDiv.innerHTML = '<h4>Operaciones Recientes:</h4>';
                
                if (data.historial.length === 0) {
                    historialDiv.innerHTML += '<p>No hay operaciones registradas</p>';
                } else {
                    data.historial.forEach(op => {
                        const opDiv = document.createElement('div');
                        opDiv.className = 'operacion';
                        opDiv.innerHTML = `
                            <span class="tipo ${op.tipo}">${op.tipo.toUpperCase()}</span>
                            <span class="dni">DNI: ${op.dni}</span>
                            <span class="fecha">${op.fecha}</span>
                            <span class="sucursal">${op.sucursal}</span>
                        `;
                        historialDiv.appendChild(opDiv);
                    });
                }
                
                document.getElementById('seccion-historial').classList.remove('hidden');
                document.getElementById('seccion-empleados').classList.add('hidden');
                actualizarEstadoSincronizacion('Historial actualizado');
            });
        });

        // Botón para ver empleados
        document.getElementById('btn-ver-empleados').addEventListener('click', function() {
            fetch('/obtener_todo')
            .then(response => response.json())
            .then(data => {
                // Mostrar empleados
                const empleadosDiv = document.getElementById('lista-empleados');
                empleadosDiv.innerHTML = '<h4>Lista de Empleados:</h4>';
                
                const empleados = Object.values(data.empleados);
                if (empleados.length === 0) {
                    empleadosDiv.innerHTML += '<p>No hay empleados registrados</p>';
                } else {
                    empleados.forEach(emp => {
                        const empDiv = document.createElement('div');
                        empDiv.className = 'empleado';
                        empDiv.innerHTML = `
                            <p><strong>DNI:</strong> ${emp.dni}</p>
                            <p><strong>Nombre:</strong> ${emp.nombre} ${emp.apellido}</p>
                            <p><strong>Puesto:</strong> ${emp.puesto}</p>
                            <p><strong>Sucursal:</strong> ${emp.sucursal}</p>
                            <hr>
                        `;
                        empleadosDiv.appendChild(empDiv);
                    });
                }
                
                document.getElementById('seccion-empleados').classList.remove('hidden');
                document.getElementById('seccion-historial').classList.add('hidden');
                actualizarEstadoSincronizacion('Lista de empleados actualizada');
            });
        });

        // Sincronizar automáticamente al cargar la página
        window.addEventListener('load', function() {
            setTimeout(() => {
                actualizarEstadoSincronizacion('Sincronizado');
            }, 1000);
        });
    </script>
</body>
</html>