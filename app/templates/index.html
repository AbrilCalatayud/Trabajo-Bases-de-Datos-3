{% extends "base.html" %}

{% block title %}Sistema de Empleados ‚Äì {{ sucursal }}{% endblock %}

{% block head %}
<style>
  /* Pesta√±as */
  .tabs { display:flex; gap:8px; flex-wrap:wrap; border-bottom:1px solid #e9ecef; margin-bottom:12px; }
  .tab { border:1px solid #e6e6e6; background:#f8f9fa; color:#2c3e50; padding:8px 12px; border-radius:8px 8px 0 0; cursor:pointer; font-weight:600; user-select:none; }
  .tab.active { background:#e8f0ff; border-color:#8cb6ff; }
  .panel { display:none; }
  .panel.active { display:block; }

  /* Cabecera compacta de la p√°gina */
  .page-head { display:grid; grid-template-columns:1fr auto; gap:12px; align-items:center; margin-bottom:12px; }
  .page-head h1 { margin:0; }
  .sticky-actions { display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center; }
  .pill { padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid #c3e6cb; background:#d4edda; color:#155724; }
  .pill.syncing { background:#fff3cd; color:#856404; border-color:#ffeaa7; }

  /* Suave para la lista con bot√≥n editar */
  .empleados .item { background:#fff; border:1px solid #e9ecef; border-radius:12px; padding:12px; margin-bottom:10px; }
  .empleados .item h4{ margin:0 0 6px 0; font-size:14px; }
  .empleados .item .muted{ color:#6b7280; font-size:12px; }
  .empleados .item .tools{ margin-top:8px; display:flex; gap:12px; }
  .linkbtn{ background:transparent; border:0; color:#0d6efd; cursor:pointer; padding:0; }
</style>
{% endblock %}

{% block content %}

  <div class="page-head">
    <div>
      <h1>Sistema de Gesti√≥n de Empleados</h1>
      <div style="color:#6b7280; margin-top:6px">{{ sucursal }} ¬∑ Puerto {{ puerto }}</div>
    </div>

    <div class="sticky-actions">
      <span id="status-sync" class="pill">
        {% if is_syncing %}Sincronizando‚Ä¶{% else %}{{ last_sync or 'Nunca sincronizado' }}{% endif %}
      </span>
      <button id="btn-sync-now" title="Traer datos desde los otros nodos">Actualizar nodo</button>
      <button id="btn-ver-historial">Historial</button>
      <button id="btn-ver-empleados">Empleados</button>
    </div>
  </div>

  <!-- Pesta√±as de operaciones -->
  <div class="tabs" role="tablist" aria-label="Operaciones">
    <div class="tab active" data-target="#panel-agregar" role="tab" aria-selected="true">‚ûï Agregar</div>
    <div class="tab" data-target="#panel-editar"  role="tab" aria-selected="false">‚úèÔ∏è Editar</div>
    <div class="tab" data-target="#panel-consultar" role="tab" aria-selected="false">üîé Consultar</div>
  </div>

  <div class="sections">
    <!-- Agregar -->
    <section id="panel-agregar" class="form-section panel active">
      <h3>Agregar Empleado</h3>
      <p style="color:#6b7280; margin:6px 0 12px">
        Carg√° un nuevo empleado. El cambio se replica cuando corra la sincronizaci√≥n (autom√°tica o manual).
      </p>
      <form id="form-agregar">
        <label>DNI</label>
        <input type="text" name="dni" placeholder="Ej: 40123456" required>
        <label>Nombre</label>
        <input type="text" name="nombre" placeholder="Nombre" required>
        <label>Apellido</label>
        <input type="text" name="apellido" placeholder="Apellido" required>
        <label>Puesto</label>
        <input type="text" name="puesto" placeholder="Ej: Analista" required>
        <button type="submit">Agregar</button>
      </form>
      <div id="resultado-agregar" class="resultado"></div>
    </section>

    <!-- Editar -->
    <section id="panel-editar" class="form-section panel">
      <h3>Editar Empleado</h3>
      <p style="color:#6b7280; margin:6px 0 12px">
        Modific√° los datos del empleado existente por DNI.
      </p>
      <form id="form-editar">
        <label>DNI</label>
        <input id="edit-dni" type="text" name="dni" placeholder="DNI a editar" required>
        <label>Nuevo Nombre</label>
        <input id="edit-nombre" type="text" name="nombre" placeholder="Nuevo nombre" required>
        <label>Nuevo Apellido</label>
        <input id="edit-apellido" type="text" name="apellido" placeholder="Nuevo apellido" required>
        <label>Nuevo Puesto</label>
        <input id="edit-puesto" type="text" name="puesto" placeholder="Nuevo puesto" required>
        <button type="submit">Guardar cambios</button>
      </form>
      <div id="resultado-editar" class="resultado"></div>
    </section>

    <!-- Consultar -->
    <section id="panel-consultar" class="form-section panel">
      <h3>Consultar Empleado</h3>
      <p style="color:#6b7280; margin:6px 0 12px">
        Busc√° un empleado por DNI. La lectura se registra en el historial y se replica en la pr√≥xima sync.
      </p>
      <form id="form-consultar">
        <label>DNI</label>
        <!-- AUTOCOMPLETE -->
        <input id="consultar-dni" list="sugerencias-dni" type="text" name="dni" placeholder="DNI a consultar" required>
        <button type="submit">Consultar</button>
      </form>
      <div id="resultado-consulta" class="resultado"></div>
    </section>
  </div>

  <!-- Listados -->
  <section id="seccion-historial" class="hidden" aria-live="polite">
    <h3>Historial de Operaciones</h3>
    <div id="historial" class="historial"></div>
  </section>

  <section id="seccion-empleados" class="hidden" aria-live="polite">
    <h3>Todos los Empleados</h3>
    <div id="lista-empleados" class="empleados"></div>
  </section>

  <!-- datalist para autocomplete -->
  <datalist id="sugerencias-dni"></datalist>
{% endblock %}

{% block scripts %}
<script>
  // ---- Tabs UI ----
  const tabs = document.querySelectorAll('.tab');
  const panels = document.querySelectorAll('.panel');
  tabs.forEach(t => t.addEventListener('click', () => {
    tabs.forEach(x => x.classList.remove('active'));
    panels.forEach(p => p.classList.remove('active'));
    t.classList.add('active');
    document.querySelector(t.dataset.target).classList.add('active');
  }));

  // ---- Estado de sincronizaci√≥n ----
  async function pollSyncStatus() {
    try {
      const r = await fetch('/sync/status');
      const s = await r.json();
      const el = document.getElementById('status-sync');
      if (s.syncing) {
        el.textContent = 'Sincronizando‚Ä¶';
        el.classList.add('syncing');
      } else {
        el.textContent = s.last_sync ? `√öltima sync: ${s.last_sync}` : 'Nunca sincronizado';
        el.classList.remove('syncing');
      }
    } catch(err) {}
  }

  document.getElementById('btn-sync-now').addEventListener('click', async () => {
    const el = document.getElementById('status-sync');
    el.textContent = 'Sincronizando‚Ä¶';
    el.classList.add('syncing');
    try { await fetch('/sync/now', {method:'POST'}); } catch(e) {}
    setTimeout(pollSyncStatus, 1000);
    setTimeout(pollSyncStatus, 2000);
    setTimeout(pollSyncStatus, 3000);
  });

  // ---- AGREGAR ----
  document.getElementById('form-agregar').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const r = await fetch('/agregar_empleado',{ method:'POST', body:new FormData(e.target) });
    const j = await r.json();
    document.getElementById('resultado-agregar').innerHTML =
      j.exito ? `<p class="success">${j.mensaje}</p>` : `<p class="error">${j.mensaje}</p>`;
    if (j.exito) e.target.reset();
  });

  // ---- EDITAR ----
  document.getElementById('form-editar').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const r = await fetch('/editar_empleado',{ method:'POST', body:new FormData(e.target) });
    const j = await r.json();
    document.getElementById('resultado-editar').innerHTML =
      j.exito ? `<p class="success">${j.mensaje}</p>` : `<p class="error">${j.mensaje}</p>`;
    if (j.exito) e.target.reset();
  });

  // ---- CONSULTAR ----
  document.getElementById('form-consultar').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const r = await fetch('/consultar_empleado',{ method:'POST', body:new FormData(e.target) });
    const j = await r.json();
    const out = document.getElementById('resultado-consulta');
    if (j.exito) {
      out.innerHTML = `
        <h4>Empleado Encontrado</h4>
        <p><strong>DNI:</strong> ${j.empleado.dni}</p>
        <p><strong>Nombre:</strong> ${j.empleado.nombre} ${j.empleado.apellido}</p>
        <p><strong>Puesto:</strong> ${j.empleado.puesto}</p>
        <p><strong>Sucursal:</strong> ${j.empleado.sucursal}</p>`;
    } else {
      out.innerHTML = `<p class="error">${j.mensaje}</p>`;
    }
  });

  // ---- AUTOCOMPLETE para Consultar ----
  function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); } }
  async function cargarSugerencias(q){
    try{
      const r = await fetch(`/empleados/suggest?q=${encodeURIComponent(q||"")}&limit=12`);
      const arr = await r.json();
      const dl = document.getElementById("sugerencias-dni"); dl.innerHTML = "";
      arr.forEach(p=>{
        const opt = document.createElement('option');
        opt.value = p.dni;
        opt.label = `${p.dni} ‚Äî ${p.nombre} ${p.apellido}`;
        dl.appendChild(opt);
      });
    }catch(e){}
  }
  const onTypeSuggest = debounce(ev => cargarSugerencias(ev.target.value.trim()), 160);
  document.getElementById("consultar-dni").addEventListener("input", onTypeSuggest);
  cargarSugerencias(""); // precargar

  // ---- HISTORIAL ----
  document.getElementById('btn-ver-historial').addEventListener('click', async ()=>{
    const r = await fetch('/ver_historial'); const data = await r.json();
    const div = document.getElementById('historial');
    div.innerHTML = '<h4>Operaciones Recientes</h4>';
    if (!data.historial.length) div.innerHTML += '<p>No hay operaciones registradas</p>';
    data.historial.forEach(op=>{
      const d=document.createElement('div'); d.className='operacion';
      d.innerHTML = `
        <span class="tipo ${op.tipo}">${op.tipo.toUpperCase()}</span>
        <span class="dni">DNI: ${op.dni}</span>
        <span class="fecha">${op.fecha}</span>
        <span class="sucursal">${op.sucursal}</span>`;
      div.appendChild(d);
    });
    document.getElementById('seccion-historial').classList.remove('hidden');
    document.getElementById('seccion-empleados').classList.add('hidden');
  });

  // ---- EMPLEADOS (con bot√≥n ‚úèÔ∏è editar) ----
  document.getElementById('btn-ver-empleados').addEventListener('click', async ()=>{
    const r = await fetch('/obtener_todo'); const data = await r.json();
    const div = document.getElementById('lista-empleados');
    div.innerHTML = '<h4>Lista de Empleados</h4>';
    const empleados = Object.values(data.empleados);
    if (!empleados.length) div.innerHTML += '<p>No hay empleados registrados</p>';
    empleados.forEach(emp=>{
      const d=document.createElement('div'); d.className='item';
      d.innerHTML = `
        <h4>DNI: ${emp.dni}</h4>
        <p><strong>Nombre:</strong> ${emp.nombre} ${emp.apellido}</p>
        <p><strong>Puesto:</strong> ${emp.puesto}</p>
        <p class="muted"><strong>Sucursal:</strong> ${emp.sucursal}</p>
        <div class="tools">
          <button class="linkbtn editar-rapido" data-dni="${emp.dni}">‚úèÔ∏è editar</button>
        </div>
        <hr>`;
      div.appendChild(d);
    });
    document.getElementById('seccion-empleados').classList.remove('hidden');
    document.getElementById('seccion-historial').classList.add('hidden');
  });

  // click en ‚úèÔ∏è ‚Üí precargar formulario Editar
  document.addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('.editar-rapido');
    if(!btn) return;
    const dni = btn.dataset.dni;
    try{
      const r = await fetch(`/empleado/${encodeURIComponent(dni)}`);
      const j = await r.json();
      if(!j.ok){ alert("No existe el empleado"); return; }
      const e = j.empleado;
      document.getElementById('edit-dni').value = e.dni;
      document.getElementById('edit-nombre').value = e.nombre;
      document.getElementById('edit-apellido').value = e.apellido;
      document.getElementById('edit-puesto').value = e.puesto;
      // cambiar a la pesta√±a Editar
      document.querySelector('.tab[data-target="#panel-editar"]').click();
      document.getElementById('edit-nombre').focus({preventScroll:true});
    }catch(err){ console.error(err); alert("Error cargando el empleado"); }
  });

  // Arranque
  window.addEventListener('load', ()=>{
    pollSyncStatus();
    setInterval(pollSyncStatus, 30000);
  });
</script>
{% endblock %}
